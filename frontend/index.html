<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn Test</title>
    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="form-container">
                <h1>Username</h1>
                <input
                type="text"
                name="username"
                id="username"
                required
                />
                <button id="registerbtn">Register</button>
                <button id="loginbtn">Login</button>
            </div>
        </header>
    </div>
    <div>
        <details>
            <summary>Status</summary>
            <section>
                <h3>Registration</h3>
                <p>Status: <span id="statusRegister"></span></p>
                <h4>Raw Output:</h4>
                <textarea id="dbgRegister" spellcheck="false"></textarea>
            </section>
        </details>
    </div>
<script>
const BASE_URL = 'http://localhost:8100'; // Base URL for backend API requests

const { startRegistration, platformAuthenticatorIsAvailable } = SimpleWebAuthnBrowser;

const statusRegister = document.getElementById("statusRegister");
const dbgRegister = document.getElementById("dbgRegister");

function printToDebug(elemDebug, title, output) {
  if (elemDebug.innerHTML !== "") {
    elemDebug.innerHTML += "\n";
  }
  elemDebug.innerHTML += `// ${title}\n`;
  elemDebug.innerHTML += `${output}\n`;
}

function resetDebug(elemDebug) {
  elemDebug.innerHTML = "";
}

function printToStatus(elemStatus, output) {
  elemStatus.innerHTML = output;
}

function resetStatus(elemStatus) {
  elemStatus.innerHTML = "";
}

function getPassStatus() {
  return "âœ…";
}
function getFailureStatus(message) {
  return `ðŸ›‘ (Reason: ${message})`;
}

document.getElementById("registerbtn").addEventListener("click", async () => {
    resetStatus(statusRegister);
    resetDebug(dbgRegister);
    const username = document.getElementById("username").value;
    
    try {
        // Fetch registration options from backend
        const resp = await fetch(`${BASE_URL}/webauth/register_options?username=${encodeURIComponent(username)}`);
        const opts = await resp.json();

        // Check if registration options are valid
        if (!opts || !opts.challenge) {
            throw new Error("Invalid registration options received from the server.");
        }

        // Print registration options to debug
        printToDebug(dbgRegister, "Registration Options", JSON.stringify(opts, null, 2));

        // Start WebAuthn registration
        const regResp = await startRegistration(opts);

        // Print registration response to debug
        printToDebug(dbgRegister, "Registration Response", JSON.stringify(regResp, null, 2));

        // Send registration response to the server for verification
        const verificationResp = await fetch(
            `${BASE_URL}/webauth/verify_registration`,
            {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ ...regResp, username }),
            }
        );

        // Report validation response
        const verificationRespJSON = await verificationResp.json();
        const { verified, msg } = verificationRespJSON;
        if (verified) {
            printToStatus(statusRegister, getPassStatus());
        } else {
            printToStatus(statusRegister, getFailureStatus(msg));
        }
        printToDebug(
            dbgRegister,
            "Verification Response",
            JSON.stringify(verificationRespJSON, null, 2)
        );
    } catch (err) {
        printToStatus(statusRegister, getFailureStatus(err.message));
        console.error("Error occurred:", err);
    }
});

// Platform Authenticator Check Logic
(async () => {
    if (await platformAuthenticatorIsAvailable()) {
        // Check if platform authenticator is available
        const userAgent = window.navigator.userAgent.toLowerCase();
        let platformAuthenticatorName = '';
        
        // User Agent analysis to determine the platform authenticator
        if (userAgent.includes('macintosh') || userAgent.includes('iphone') || userAgent.includes('ipad')) {
            if (userAgent.includes('macintosh')) {
                platformAuthenticatorName = 'Touch ID';
            } else if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
                platformAuthenticatorName = 'Face ID';
            }
        } else if (userAgent.includes('windows')) {
            platformAuthenticatorName = 'Windows Hello';
        } else {
            platformAuthenticatorName = 'Platform Authenticator';
        }
        
        // Prompt the user to use the platform authenticator
        const confirmation = confirm(`You can use ${platformAuthenticatorName} or security keys for registration or authentication. Do you want to proceed?`);
        if (confirmation) {
            // User confirmed, proceed with registration or authentication using platform authenticator
        } else {
            // User declined, provide alternative option
            // Example: Prompt the user to use security keys
            alert('You can use security keys for registration or authentication.');
        }
    } else {
        // Prompt the user to use security keys
        alert('You can use security keys for registration or authentication.');
    }
})();
</script>
</body>
</html>
