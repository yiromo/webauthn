<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn Test</title>
    <link rel="stylesheet" href="styles.css">
    <script src = simplewebauthn-browser.4.1.0.umd.min.js></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="form-container">
                <h1>Username</h1>
                <input
                type="text"
                name="username"
                id="username"
                required
                />
                <button id="registerbtn">Register</button>
                <button id="loginbtn">Login</button>
            </div>
        </header>
    </div>
    <div>
        <details>
            <summary>Status</summary>
            <section>
                <h3>Registration</h3>
                <p>Status: <span id="statusRegister"></span></p>
                <h4>Raw Output:</h4>
                <textarea id="dbgRegister" spellcheck="false"></textarea>
            </section>
        </details>
    </div>
<script>
const BASE_URL = 'http://localhost:8100'; 

const { startRegistration, platformAuthenticatorIsAvailable, startAuthentication } = SimpleWebAuthnBrowser;

const statusRegister = document.getElementById("statusRegister");
const dbgRegister = document.getElementById("dbgRegister");

function printToDebug(elemDebug, title, output) {
  if (elemDebug.innerHTML !== "") {
    elemDebug.innerHTML += "\n";
  }
  elemDebug.innerHTML += `// ${title}\n`;
  elemDebug.innerHTML += `${output}\n`;
}

function resetDebug(elemDebug) {
  elemDebug.innerHTML = "";
}

function printToStatus(elemStatus, output) {
  elemStatus.innerHTML = output;
}

function resetStatus(elemStatus) {
  elemStatus.innerHTML = "";
}

function getPassStatus() {
  return "âœ…";
}
function getFailureStatus(message) {
  return `ðŸ›‘ (Reason: ${message})`;
}

document.getElementById("registerbtn").addEventListener("click", async () => {
    resetStatus(statusRegister);
    resetDebug(dbgRegister);
    const username = document.getElementById("username").value;
    
    try {
        const resp = await fetch(`${BASE_URL}/webauth/register_options?username=${encodeURIComponent(username)}`);
        const opts = await resp.json();

        console.log("Received registration options:", opts);

        //if (!opts || !opts.challenge) {
        //   throw new Error("Invalid registration options received from the server.");
        //}

        printToDebug(dbgRegister, "Registration Options", JSON.stringify(opts, null, 2));

        const regResp = await startRegistration(opts);
        console.log("Received registration options:", opts);

        printToDebug(dbgRegister, "Registration Response", JSON.stringify(regResp, null, 2));

        const verificationResp = await fetch(
            `${BASE_URL}/webauth/verify_registration`,
            {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({regResp}),
            }
        );

        const verificationRespJSON = await verificationResp.json();
        const { verified, msg } = verificationRespJSON;
        if (verified) {
            printToStatus(statusRegister, getPassStatus());
        } else {
            printToStatus(statusRegister, getFailureStatus(msg));
        }
        printToDebug(
            dbgRegister,
            "Verification Response",
            JSON.stringify(verificationRespJSON, null, 2)
        );
    } catch (err) {
        printToStatus(statusRegister, getFailureStatus(err.message));
        console.error("Error occurred:", err);
    }
});


document.getElementById("loginbtn").addEventListener("click", async () => {
    resetStatus(statusAuthenticate);
    resetDebug(dbgAuthenticate);

    const resp = await fetch("${BASE_URL}/webauth//generate-authentication-options");
    const opts = await resp.json();
    printToDebug(
      dbgAuthenticate,
      "Authentication Options",
      JSON.stringify(opts, null, 2)
    );

    // Start WebAuthn Authentication
    let authResp;
    try {
      authResp = await startAuthentication(opts);
      printToDebug(
        dbgAuthenticate,
        "Authentication Response",
        JSON.stringify(authResp, null, 2)
      );
    } catch (err) {
      printToStatus(statusAuthenticate, getFailureStatus(err));
      throw new Error(err);
    }

    // Send response to server
    const verificationResp = await fetch(
      "/verify-authentication-response",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(authResp),
      }
    );

    // Report validation response
    const verificationRespJSON = await verificationResp.json();
    const { verified, msg } = verificationRespJSON;
    if (verified) {
      printToStatus(statusAuthenticate, getPassStatus());
    } else {
      printToStatus(statusAuthenticate, getFailureStatus(msg));
    }
    printToDebug(
      dbgAuthenticate,
      "Verification Response",
      JSON.stringify(verificationRespJSON, null, 2)
    );
});

// Platform Authenticator Check Logic
(async () => {
    if (await platformAuthenticatorIsAvailable()) {
        // Check if platform authenticator is available
        const userAgent = window.navigator.userAgent.toLowerCase();
        let platformAuthenticatorName = '';
        
        // User Agent analysis to determine the platform authenticator
        if (userAgent.includes('macintosh') || userAgent.includes('iphone') || userAgent.includes('ipad')) {
            if (userAgent.includes('macintosh')) {
                platformAuthenticatorName = 'Touch ID';
            } else if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
                platformAuthenticatorName = 'Face ID';
            }
        } else if (userAgent.includes('windows')) {
            platformAuthenticatorName = 'Windows Hello';
        } else {
            platformAuthenticatorName = 'Platform Authenticator';
        }
        
        // Prompt the user to use the platform authenticator
        const confirmation = confirm(`You can use ${platformAuthenticatorName} or security keys for registration or authentication. Do you want to proceed?`);
        if (confirmation) {
    // User confirmed, proceed with registration or authentication using platform authenticator
    
    // Check if the action is registration or login
    const action = document.getElementById("registerbtn").disabled ? "login" : "register";

    // Prepare the request data based on the action
    const requestData = {
        action: action,
        username: document.getElementById("username").value,
        platformAuthenticatorName: platformAuthenticatorName
    };

    try {
        // Send the request to the server
        const response = await fetch(`${BASE_URL}/webauth/${action}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
        });

        // Handle the response
        const responseData = await response.json();
        if (responseData.success) {
            // If the server indicates success, update the UI accordingly
            if (action === "register") {
                printToStatus(statusRegister, getPassStatus());
            } else {
                // Handle successful login
            }
        } else {
            // If the server indicates failure, display the error message
            printToStatus(statusRegister, getFailureStatus(responseData.message));
        }
    } catch (err) {
        // Handle any errors that occur during the request
        printToStatus(statusRegister, getFailureStatus(err.message));
        console.error("Error occurred:", err);
    }
} else {
    // User declined, provide alternative option
    // Example: Prompt the user to use security keys
    alert('You can use security keys for registration or authentication.');
}

    } else {
        // Prompt the user to use security keys
        alert('You can use security keys for registration or authentication.');
    }
})();


</script>
</body>
</html>
